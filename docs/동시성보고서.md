# ë™ì‹œì„± ì œì–´ ë³´ê³ ì„œ

---

## 1. ì¢Œì„ ì˜ˆì•½

### 1.1 ë°°ê²½
- ì¢Œì„ ì˜ˆì•½ì‹œ ì¢Œì„ì˜ ìƒíƒœê°€ ë³€ê²½ë¨ì— ë”°ë¼ ì—¬ëŸ¬ ìœ ì €ê°€ ë™ì‹œì— í•˜ë‚˜ì˜ ì¢Œì„ì„ ì˜ˆì•½í•  ë•Œ ì¤‘ë³µìœ¼ë¡œ ì˜ˆì•½ë˜ëŠ” ìƒí™© ë°œìƒí•˜ê³ ìˆìŠµë‹ˆë‹¤.
- ì ì ˆí•œ ë½ì„ ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•˜ê³ ì í•©ë‹ˆë‹¤.

### 1.2 ë¬¸ì œ ì‹ë³„
- ğŸ’¥ ë™ì‹œì„± ì´ìŠˆ ì„¤ëª…

    - ë™ì‹œì„± ì´ìŠˆëŠ” ë°ì´í„°ë¥¼ ì¡°íšŒí•œ ë’¤ ìˆ˜ì • ë° ì €ì¥í•˜ëŠ” ê³¼ì •ì—ì„œ ì£¼ë¡œ ë°œìƒí•©ë‹ˆë‹¤.
    - í˜„ì¬ ì˜ˆì•½ ë¡œì§ì—ì„œëŠ” ì„ íƒí•œ ì¢Œì„ì„ ì¡°íšŒí•œ ë’¤ ìƒíƒœë¥¼ ë³€ê²½í•˜ì—¬ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.
    - ì´ ê³¼ì •ì—ì„œ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ê°™ì€ ì¢Œì„ì„ ì˜ˆì•½í•˜ë ¤ í•  ê²½ìš°, ì¤‘ë³µ ì˜ˆì•½ì´ ë°œìƒí•˜ëŠ” ë™ì‹œì„± ë¬¸ì œê°€ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.

- ğŸ’£ ì¶©ëŒ ê°€ëŠ¥ ì‹œë‚˜ë¦¬ì˜¤

    - íŠ¸ëœì­ì…˜ A
        1. seat ì¡°íšŒ(ìƒíƒœ: ì˜ˆì•½ ê°€ëŠ¥)
        2. Reservation ê°ì²´ìƒì„±
        3. seat.reserve() í˜¸ì¶œ -> ì¢Œì„ ìƒíƒœ ê²€ì¦ -> ì¢Œì„ìƒíƒœ ë³€ê²½(ë©”ëª¨ë¦¬ìƒ)
        4. Reservation ì €ì¥ â†’ ì¢Œì„ ì •ë³´ í•¨ê»˜ ì €ì¥
        5. íŠ¸ëœì­ì…˜ commit

    - íŠ¸ëœì­ì…˜ B (íŠ¸ëœì­ì…˜ Aì™€ ê±°ì˜ ë™ì‹œ ì‹¤í–‰)
        1. seat ì¡°íšŒ(ìƒíƒœ: ì˜ˆì•½ ê°€ëŠ¥ -  íŠ¸ëœì­ì…˜ A ë¯¸ì»¤ë°‹ ìƒíƒœ)
        2. Reservation ê°ì²´ìƒì„±
        3. seat.reserve() í˜¸ì¶œ -> ì¢Œì„ ìƒíƒœ ê²€ì¦ -> ì¢Œì„ìƒíƒœ ë³€ê²½(ë©”ëª¨ë¦¬ìƒ)
        4. Reservation ì €ì¥ â†’ ì¢Œì„ ì •ë³´ í•¨ê»˜ ì €ì¥
        5. íŠ¸ëœì­ì…˜ commit

> íŠ¸ëœì­ì…˜ Aê°€ ì»¤ë°‹ë˜ê¸° ì „ì— íŠ¸ëœì­ì…˜ Bê°€ ì¢Œì„ì„ ì¡°íšŒí•˜ë©´, í•´ë‹¹ ì¢Œì„ì€ ì—¬ì „íˆ ì˜ˆì•½ ê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤.
> ì´ë¡œ ì¸í•´ íŠ¸ëœì­ì…˜ Bê°€ ì¢Œì„ ìƒíƒœë¥¼ ê²€ì¦í•˜ë”ë¼ë„, ì‹¤ì œë¡œëŠ” ì´ë¯¸ ì˜ˆì•½ëœ ì¢Œì„ì„ ë‹¤ì‹œ ì˜ˆì•½í•˜ê²Œ ë˜ì–´ ì¤‘ë³µ ì˜ˆì•½ì´ ë°œìƒí•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

### 1.3 í•´ê²° ë°©ì•ˆ

ì²˜ìŒì—ëŠ” ì¢Œì„ ì˜ˆì•½ ê¸°ëŠ¥ì˜ íŠ¹ì„±ìƒ ë°ì´í„° ì •í•©ì„±ì´ ë§¤ìš° ì¤‘ìš”í•˜ê³ , ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ì¶©ëŒí•  ê°€ëŠ¥ì„±ì´ ë†’ê¸° ë•Œë¬¸ì— ë¹„ê´€ì  ë½ì„ ì ìš©í•´ ë™ì‹œì„±ì„ ì œì–´í•´ì•¼ í•œë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œë¡œ ë¹„ê´€ì  ë½ì„ ì ìš©í•œ í›„, í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í†µí•´ ë™ì‹œì„± ë¬¸ì œë¥¼ ê²€ì¦í•˜ê¸°ë„ í–ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ë‹¤ì‹œ ìƒê°í•´ë³´ë‹ˆ, ì¢Œì„ ì˜ˆì•½ì€ í•œ ëª…ë§Œ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ ìš”ì²­ì€ ëª¨ë‘ ì‹¤íŒ¨í•˜ë©´ ë˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤. ì´ëŸ° ìƒí™©ì—ì„œ ë¹„ê´€ì  ë½ì€ ì˜¤íˆë ¤ ë³‘ëª© í˜„ìƒì„ ìœ ë°œí•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ì— ê³¼ë„í•œ ë¶€í•˜ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¹„ê´€ì  ë½ì„ ì‚¬ìš©í•˜ë©´ ì¢Œì„ ì „ì²´ë¥¼ ì¡°íšŒí•  ë•Œë„ ë½ì´ ê±¸ë¦° ì¢Œì„ì´ ìˆì„ ê²½ìš° ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ì ë“¤ì„ ê³ ë ¤í•´, ë‚™ê´€ì  ë½ì„ ì ìš©í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤. í•œ ëª…ì´ ë¨¼ì € ì¢Œì„ì„ ì„ ì í•˜ë©´, ì´í›„ ìš”ì²­ì€ ë²„ì „ ì¶©ëŒë¡œ ì¸í•´ ì‹¤íŒ¨í•˜ê³  ì˜ˆì™¸ë¥¼ í†µí•´ ì´ë¥¼ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ì„±ëŠ¥ ì¸¡ë©´ì—ì„œë„ ìœ ë¦¬í•˜ê³ , ë°ì´í„° ì •í•©ì„±ë„ ì¶©ë¶„íˆ ë³´ì¥í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.

``` java
// domain Seat
public class Seat extends BaseEntity {  
  
    @Id  
    @Column(name = "seat_id")  
    @GeneratedValue(strategy = IDENTITY)  
    private Long id;  
  
    @ManyToOne(fetch = LAZY)  
    @JoinColumn(name = "schedule_id", nullable = false, foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT))  
    private Schedule schedule;  
  
    private String number;  
  
    private Long price;  
  
    private Boolean isSelectable;  
  
    @Version  
    private Long version;
}

// infras SeatJpaRepository
public interface SeatJpaRepository extends JpaRepository<Seat, Long> {  
    @Lock(LockModeType.OPTIMISTIC)  
    @Query("SELECT s FROM Seat s WHERE s.id = :id")  
    Optional<Seat> findByIdWithLock(@Param("id") Long id);  
}

// infras ConcertRepositoryImpl
public class ConcertRepositoryImpl implements ConcertRepository {  
  
    private final SeatJpaRepository seatJpaRepository;  
    private final ConcertJpaRepository concertJpaRepository;  
    private final ScheduleJpaRepository scheduleJpaRepository;  
    
    @Override  
    public Optional<Seat> findSeatById(Long SeatId) {  
       return seatJpaRepository.findByIdWithLock(SeatId);  
    }
}
```

Seat ì—”í‹°í‹°ì— @Versionì„ ì¶”ê°€í•˜ê³ , SeatJpaRepositoryì˜ ì¿¼ë¦¬ì— @Lock(LockModeType.OPTIMISTIC)ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì´í›„ ConcertRepositoryImplì—ì„œ findByIdWithLock() ë©”ì„œë“œë¥¼ í†µí•´ ì¢Œì„ì„ ì¡°íšŒí•˜ë„ë¡ ë³€ê²½í•˜ì—¬, ì¡°íšŒ ì‹œ ë‚™ê´€ì  ë½ì´ ì ìš©ë˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
### 1.4 í…ŒìŠ¤íŠ¸ ë° ì‹¤í—˜

``` java
@Test  
@DisplayName("ë™ì‹œì— ì¢Œì„ ì˜ˆì•½ì„ ì‹œë„í•˜ë©´ í•˜ë‚˜ë§Œ ì„±ê³µí•´ì•¼í•œë‹¤.")  
void concurrent_reservation() throws InterruptedException {  
    // arrange  
    User user = new User("kimbro", "1234");  
    userJpaRepository.save(user);  
  
    Concert concert = new Concert("ì•„ì´ìœ  10ì£¼ë…„ ì½˜ì„œíŠ¸");  
    concertJpaRepository.save(concert);  
  
    Schedule schedule = new Schedule(concert, LocalDate.now());  
    scheduleJpaRepository.save(schedule);  
  
    Seat seat = new Seat(schedule, "A1", 1000L, true);  
    seatJpaRepository.save(seat);  
  
    ReservationCommand command = new ReservationCommand(user.getId(), schedule.getId(), seat.getId());  
  
    int threadCount = 10;  
    ExecutorService executorService = Executors.newFixedThreadPool(threadCount);  
    CountDownLatch latch = new CountDownLatch(threadCount);  
  
    AtomicInteger successCount = new AtomicInteger(0);  
    AtomicInteger failCount = new AtomicInteger(0);  
  
    for (int i = 0; i < threadCount; i++) {  
       executorService.submit(() -> {  
          try {  
             reservationService.reserve(command);  
             successCount.incrementAndGet();  
          } catch (Exception e) {  
             failCount.incrementAndGet();  
          } finally {  
             latch.countDown();  
          }  
       });  
    }  
  
    latch.await();  
  
    // assert  
    List<Reservation> reservations = reservationJpaRepository.findAll();  
    assertThat(reservations).hasSize(1);  
    assertThat(successCount.get()).isEqualTo(1);  
    assertThat(failCount.get()).isEqualTo(9);  
}
```

10ê°œì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— í•˜ë‚˜ì˜ ì¢Œì„ì„ ì˜ˆì•½í•˜ë„ë¡ í…ŒìŠ¤íŠ¸ë¥¼ êµ¬ì„±í•˜ê³ , ì´ ì¤‘ 1ê±´ë§Œ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ 9ê±´ì€ ì‹¤íŒ¨í•˜ëŠ”ì§€ë¥¼ ê²€ì¦í•˜ì—¬ í†µê³¼í–ˆìŠµë‹ˆë‹¤.
### 1.5 ê²°ë¡ 

ì˜ˆì•½ ë¡œì§ì˜ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•˜ë©´ì„œ ëŠë‚€ ì ì€, ì¶©ëŒì´ ì¦ì„ ë•ŒëŠ” ë¹„ê´€ì  ë½ì„, ê·¸ë ‡ì§€ ì•Šì„ ë•ŒëŠ” ë‚™ê´€ì  ë½ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ê³ ì •ê´€ë…ì´ ê¹¨ì¡ŒìŠµë‹ˆë‹¤.

ì˜ˆì•½ê³¼ ê°™ì´ ì¶©ëŒì´ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ëŠ” ìƒí™©ì—ì„œë„, ìƒí™©ì— ë”°ë¼ ë‚™ê´€ì  ë½ì„ í†µí•´ ì¶©ë¶„íˆ ë™ì‹œì„±ì„ ì œì–´í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ê²½í—˜í–ˆê³ , ë½ì€ ì •í•´ì§„ ê³µì‹ì²˜ëŸ¼ ì ìš©í•˜ê¸°ë³´ë‹¤ëŠ” ìƒí™©ì— ë§ê²Œ ìœ ì—°í•˜ê²Œ ì„ íƒí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ëŠê¼ˆìŠµë‹ˆë‹¤.

---

## 2. í¬ì¸íŠ¸ ì¶©ì „

### 2.1 ë°°ê²½
- í¬ì¸íŠ¸ ì¶©ì „ ì‹œ ì”ì•¡ì´ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì—, ë™ì¼í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— ì¶©ì „ì„ ì‹œë„í•  ê²½ìš° ì”ì•¡ì´ ì •í™•í•˜ê²Œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
- ì ì ˆí•œ ë½ì„ ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•˜ê³ ì í•©ë‹ˆë‹¤.

### 2.2 ë¬¸ì œ ì‹ë³„
- ğŸ’¥ ë™ì‹œì„± ì´ìŠˆ ì„¤ëª…

    - í˜„ì¬ í¬ì¸íŠ¸ ì¶©ì „ ë¡œì§ì—ì„œëŠ” ì‚¬ìš©ìì˜ ì”ì•¡ ì •ë³´ë¥¼ ì¡°íšŒí•œ ë’¤, ì¶©ì „ ê¸ˆì•¡ì„ ë”í•´ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.
    - ì´ ê³¼ì •ì—ì„œ ë™ì¼í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•˜ë ¤ í•  ê²½ìš°, ì¡°íšŒí•œ ì”ì•¡ì´ ë™ì¼í•˜ê²Œ ìœ ì§€ë˜ë©´ì„œ ë®ì–´ì“°ê¸° í˜„ìƒì´ ë°œìƒí•´ ìµœì¢… ì”ì•¡ì´ ì •í™•í•˜ê²Œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ë™ì‹œì„± ë¬¸ì œê°€ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.

- ğŸ’£ ì¶©ëŒ ê°€ëŠ¥ ì‹œë‚˜ë¦¬ì˜¤

    - íŠ¸ëœì­ì…˜ A
        1. ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ (ì˜ˆ: 1,000ì›)
        2. ì¶©ì „ ê¸ˆì•¡ 500ì› ê³„ì‚° â†’ ì´ 1,500ì› ì˜ˆìƒ
        3. ì”ì•¡ì— 500ì› ì¶”ê°€ â†’ ë©”ëª¨ë¦¬ ìƒ ë³€ê²½
        4. ë³€ê²½ëœ ì”ì•¡ ì €ì¥
        5. íŠ¸ëœì­ì…˜ commit

    - íŠ¸ëœì­ì…˜ B (íŠ¸ëœì­ì…˜ Aì™€ ê±°ì˜ ë™ì‹œ ì‹¤í–‰)
        1. ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ (ì˜ˆ: ì—¬ì „íˆ 1,000ì› â€” íŠ¸ëœì­ì…˜ AëŠ” ì•„ì§ commitë˜ì§€ ì•ŠìŒ)
        2. ì¶©ì „ ê¸ˆì•¡ 700ì› ê³„ì‚° â†’ ì´ 1,700ì› ì˜ˆìƒ
        3. ì”ì•¡ì— 700ì› ì¶”ê°€ â†’ ë©”ëª¨ë¦¬ ìƒ ë³€ê²½
        4. ë³€ê²½ëœ ì”ì•¡ ì €ì¥
        5. íŠ¸ëœì­ì…˜ commit

> ì‹¤ì œë¡œëŠ” ë‘ ì¶©ì „ì´ ëª¨ë‘ ë°˜ì˜ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ìµœì¢… ì”ì•¡ì€ 2,200ì›ì´ì–´ì•¼í•˜ì§€ë§Œ ê° íŠ¸ëœì­ì…˜ì´ ë™ì¼í•œ ì´ˆê¸° ì”ì•¡(1,000ì›)ì„ ê¸°ì¤€ìœ¼ë¡œ ë®ì–´ì“°ê¸°í–ˆê¸° ë•Œë¬¸ì—, ë§ˆì§€ë§‰ì— ì»¤ë°‹ëœ íŠ¸ëœì­ì…˜ ê¸°ì¤€ìœ¼ë¡œ ì”ì•¡ì´ 1,700ì› ë˜ëŠ” 1,500ì›ë§Œ ë‚¨ê²Œ ë˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤.
> ì´ë¡œ ì¸í•´ ì¶©ì „ ê¸ˆì•¡ ì¼ë¶€ê°€ ìœ ì‹¤ë˜ëŠ” ë™ì‹œì„± ë¬¸ì œë°œìƒ

### 2.3 í•´ê²° ë°©ì•ˆ

ì²˜ìŒì—ëŠ” í¬ì¸íŠ¸ ì¶©ì „ì´ ê¸ˆì•¡ê³¼ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ëœ ë¡œì§ì´ê¸° ë•Œë¬¸ì—, ë°ì´í„° ì •í•©ì„±ì´ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì¶©ì „ ìš”ì²­ ê°„ì˜ ì¶©ëŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë¹„ê´€ì  ë½ì„ ì ìš©í•´ ë™ì‹œì„±ì„ ì œì–´í•´ì•¼ í•œë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ë™ì¼í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•˜ëŠ” ìƒí™© ìì²´ê°€ ì‹¤ì œ ì„œë¹„ìŠ¤ íë¦„ìƒ ìì£¼ ë°œìƒí•˜ëŠ” ì¼€ì´ìŠ¤ëŠ” ì•„ë‹ˆë©°, ëŒ€ë¶€ë¶„ì€ ë¸Œë¼ìš°ì €ë¥¼ ì—¬ëŸ¬ ê°œ ë„ìš°ê±°ë‚˜ ì¸ìœ„ì ìœ¼ë¡œ ë™ì‹œì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¹„ì •ìƒì ì¸ ì‚¬ìš© íŒ¨í„´ì¼ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ìƒí™©ì—ì„œ ë¹„ê´€ì  ë½ì„ ì ìš©í•˜ë©´ ëª¨ë“  ìš”ì²­ì„ ì¼ë‹¨ ìˆ˜ë½í•œ ë’¤ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê²Œ ë˜ì–´ í¬ì¸íŠ¸ë¥¼ ë” ë§ì´ ì¶©ì „í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ì ë“¤ì„ ê³ ë ¤í•´, í¬ì¸íŠ¸ ì¶©ì „ ë¡œì§ì—ëŠ” ë‚™ê´€ì  ë½ì„ ì ìš©í•˜ëŠ” ë°©ì‹ì´ ë” ì ì ˆí•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.

``` java
// domain Balance
public class Balance extends BaseEntity {  
    @Id  
    @Column(name = "balance_id")  
    @GeneratedValue(strategy = IDENTITY)  
    private Long id;  
  
    @OneToOne  
    @JoinColumn(name = "user_id", nullable = false, foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT))  
    private User user;  
  
    private Long amount;  
  
    @Version  
    private Long version;
}

// infras BalanceJpaRepository
public interface BalanceJpaRepository extends JpaRepository<Balance, Long> { 
    @Lock(LockModeType.OPTIMISTIC)  
    @Query("SELECT b FROM Balance b WHERE b.user.id= :userId")  
    Optional<Balance> findByUserIdWithLock(@Param("userId") Long userId);  
}
// infras BalanceRepositoryImpl
public class BalanceRepositoryImpl implements BalanceRepository {  
  
    private final BalanceJpaRepository balanceJpaRepository;  
    
    @Override  
    public Optional<Balance> findByUserId(Long userId) {  
       return balanceJpaRepository.findByUserIdWithLock(userId);  
    }  
}
```

Balance ì—”í‹°í‹°ì— @Versionì„ ì¶”ê°€í•˜ê³ , BalanceJpaRepositoryì˜ ì¿¼ë¦¬ì— @Lock(LockModeType.OPTIMISTIC)ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì´í›„ BalanceRepositoryImplì—ì„œ findByUserIdWithLock() ë©”ì„œë“œë¥¼ í†µí•´ ì”ì•¡ì„ ì¡°íšŒí•˜ë„ë¡ ë³€ê²½í•˜ì—¬, ì¡°íšŒ ì‹œ ë‚™ê´€ì  ë½ì´ ì ìš©ë˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
### 2.4 í…ŒìŠ¤íŠ¸ ë° ì‹¤í—˜

``` java
@Test  
@DisplayName("í•œ ëª…ì˜ íšŒì›ì´ 2ë²ˆ ë™ì‹œì— ì”ì•¡ì„ ì¶©ì „í•˜ë©´ 1ë²ˆ ì„±ê³µ, 1ë²ˆ ì‹¤íŒ¨í•˜ì—¬ ìµœì¢… ê¸ˆì•¡ì€ 1000ì›ì´ë‹¤.")  
void concurrent_charge_success() throws InterruptedException {  
    // arrange  
    User user = new User("kimbro", "1234");  
    userJpaRepository.save(user);  
  
    Balance balance = new Balance(user, 0L);  
    balanceJpaRepository.save(balance);  
  
    int threadCount = 2;  
    Long chargeAmount = 1000L;  
    ExecutorService executorService = Executors.newFixedThreadPool(threadCount);  
    CountDownLatch latch = new CountDownLatch(threadCount);  
  
    AtomicInteger successCount = new AtomicInteger(0);  
    AtomicInteger failCount = new AtomicInteger(0);  
  
    // act  
    for (int i = 0; i < threadCount; i++) {  
       executorService.submit(() -> {  
          try {  
             BalanceCommand.Charge command = new BalanceCommand.Charge(user.getId(), chargeAmount);  
             balanceService.charge(command);  
             successCount.incrementAndGet();  
          } catch (Exception e) {  
             failCount.incrementAndGet();  
          } finally {  
             latch.countDown();  
          }  
       });  
    }  
  
    latch.await();  
  
    // assert  
    Balance finalBalance = balanceJpaRepository.findByUserId(user.getId()).orElseThrow();  
    assertThat(finalBalance.getAmount()).isEqualTo(1000L);  
    assertThat(successCount.get()).isEqualTo(1);  
    assertThat(failCount.get()).isEqualTo(1);  
}
```

ë™ì¼í•œ ìœ ì €ì— ì˜í•œ ì¤‘ë³µ ì¶©ì „ ìš”ì²­ ì‹œ í•˜ë‚˜ë§Œ ì„±ê³µí•˜ë„ë¡ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ë¥¼ êµ¬ì„±í–ˆìœ¼ë©°, ê¸°ëŒ€í•œ ëŒ€ë¡œ 1ê±´ì€ ì„±ê³µí•˜ê³  1ê±´ì€ ì‹¤íŒ¨í•˜ëŠ” ê²°ê³¼ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

---

## 3. ê²°ì œì‹œ í¬ì¸íŠ¸ ì°¨ê°

### 3.1 ë°°ê²½
- ê²°ì œ ë¡œì§ì—ì„œ í¬ì¸íŠ¸ ì°¨ê° ì‹œ ì”ì•¡ì´ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì—, ë™ì¼í•œ ê²°ì œ ìš”ì²­ì´ ë™ì‹œì— ë‘ ë²ˆ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ì”ì•¡ì´ ì •í™•í•˜ê²Œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
- ë¿ë§Œ ì•„ë‹ˆë¼, í•˜ë‚˜ì˜ ì˜ˆì•½ ê±´ì— ëŒ€í•´ ë‘ ê°œì˜ ê²°ì œê°€ ìƒì„±ë˜ëŠ” ì´ìŠˆë„ í•¨ê»˜ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.
- ì ì ˆí•œ ë½ì„ ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•˜ê³ ì í•©ë‹ˆë‹¤.

### 3.2 ë¬¸ì œ ì‹ë³„
- ğŸ’¥ ë™ì‹œì„± ì´ìŠˆ ì„¤ëª…

    - ê²°ì œì‹œ ë™ì‹œì„± ì´ìŠˆëŠ” í¬ì¸íŠ¸ ì¶©ì „ê³¼ ê°™ì€ ì´ìŠˆë¡œ í¬ì¸íŠ¸ ì‚¬ìš©ê¸ˆì•¡ì„ ì°¨ê°í•˜ê³  ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.
    - ì´ ê³¼ì •ì—ì„œ ê²°ì œê°€ ë™ì‹œì— 2ë²ˆ ìš”ì²­ë  ê²½ìš°, ì¡°íšŒí•œ ì”ì•¡ì´ ë™ì¼í•˜ê²Œ ìœ ì§€ë˜ë©´ì„œ ë®ì–´ì“°ê¸° í˜„ìƒì´ ë°œìƒí•´ ìµœì¢… ì”ì•¡ì´ ì •í™•í•˜ê²Œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ë™ì‹œì„± ë¬¸ì œê°€ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.

- ğŸ’£ ì¶©ëŒ ê°€ëŠ¥ ì‹œë‚˜ë¦¬ì˜¤

    - íŠ¸ëœì­ì…˜ A
        1. ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ (ì˜ˆ: 2,000ì›)
        2. ì‚¬ìš© ê¸ˆì•¡ 500ì› ê³„ì‚° â†’ ì´ 1,500ì› ì˜ˆìƒ
        3. ì”ì•¡ì— 500ì› ì°¨ê° â†’ ë©”ëª¨ë¦¬ ìƒ ë³€ê²½
        4. ë³€ê²½ëœ ì”ì•¡ ì €ì¥
        5. íŠ¸ëœì­ì…˜ commit

    - íŠ¸ëœì­ì…˜ B (íŠ¸ëœì­ì…˜ Aì™€ ê±°ì˜ ë™ì‹œ ì‹¤í–‰)
        1. ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ (ì˜ˆ: ì—¬ì „íˆ 2,000ì› â€” íŠ¸ëœì­ì…˜ AëŠ” ì•„ì§ commitë˜ì§€ ì•ŠìŒ)
        2. ì‚¬ìš© ê¸ˆì•¡ 700ì› ê³„ì‚° â†’ ì´ 1,300ì› ì˜ˆìƒ
        3. ì”ì•¡ì— 700ì› ì°¨ê° â†’ ë©”ëª¨ë¦¬ ìƒ ë³€ê²½
        4. ë³€ê²½ëœ ì”ì•¡ ì €ì¥
        5. íŠ¸ëœì­ì…˜ commit

> ì‹¤ì œë¡œëŠ” ë‘ ê±´ì˜ ì¶©ì „ì´ ëª¨ë‘ ë°˜ì˜ë˜ì–´ ìµœì¢… ì”ì•¡ì´ 800ì›ì´ ë˜ì–´ì•¼ í•˜ì§€ë§Œ, ê° íŠ¸ëœì­ì…˜ì´ ë™ì¼í•œ ì´ˆê¸° ì”ì•¡(2,000ì›)ì„ ê¸°ì¤€ìœ¼ë¡œ ë®ì–´ì“°ê¸°í•˜ë©´ì„œ, ë§ˆì§€ë§‰ì— ì»¤ë°‹ëœ íŠ¸ëœì­ì…˜ì˜ ê²°ê³¼ì— ë”°ë¼ ì”ì•¡ì´ 1,300ì› ë˜ëŠ” 1,500ì›ìœ¼ë¡œ ì˜ëª» ë°˜ì˜ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
> ë˜í•œ, í•˜ë‚˜ì˜ ì˜ˆì•½ ê±´ì— ëŒ€í•´ ê²°ì œ ì •ë³´ê°€ ë‘ ê°œ ìƒì„±ë˜ëŠ” ë¬¸ì œë„ í•¨ê»˜ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.
> ì´ë¡œ ì¸í•´ ì¶©ì „ ê¸ˆì•¡ ì¼ë¶€ê°€ ìœ ì‹¤ë˜ëŠ” ë™ì‹œì„± ë¬¸ì œë°œìƒ

### 3.3 í•´ê²° ë°©ì•ˆ

ê²°ì œ ìš”ì²­ì´ ë™ì‹œì— ë‘ ë²ˆ ë“¤ì–´ì˜¤ëŠ” ìƒí™©ì€ ì¼ë°˜ì ì¸ ì‚¬ìš© íë¦„ì´ë¼ê¸°ë³´ë‹¤ëŠ”, ë¹„ì •ìƒì ì¸ ë™ì‘ì´ë‚˜ ì¸ìœ„ì ì¸ ìš”ì²­ ì¡°ì‘ìœ¼ë¡œ ì¸í•´ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.

ë˜í•œ í•˜ë‚˜ì˜ ì˜ˆì•½ ê±´ì— ëŒ€í•´ ê²°ì œê°€ ì¤‘ë³µìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ í¬ì¸íŠ¸ê°€ ë‘ ë²ˆ ì°¨ê°ë˜ê³ , ê²°ì œ ì •ë³´ê°€ ë‘ ê±´ ìƒì„±ë˜ëŠ” ë¬¸ì œëŠ” ë°˜ë“œì‹œ ë°©ì§€í•´ì•¼ í•œë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ê³ ë ¤í–ˆì„ ë•Œ, í¬ì¸íŠ¸ ì°¨ê° ë¡œì§ì—ëŠ” ë‚™ê´€ì  ë½ì„ ì ìš©í•˜ì—¬ ë¨¼ì € ì²˜ë¦¬ëœ ìš”ì²­ë§Œ ì„±ê³µí•˜ê³  ì´í›„ ìš”ì²­ì€ ë²„ì „ ì¶©ëŒì„ í†µí•´ ì‹¤íŒ¨í•˜ë„ë¡ ì„¤ê³„í•˜ëŠ” ê²ƒì´ ë” ì ì ˆí•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.

``` java
// domain Balance
public class Balance extends BaseEntity {  
    @Id  
    @Column(name = "balance_id")  
    @GeneratedValue(strategy = IDENTITY)  
    private Long id;  
  
    @OneToOne  
    @JoinColumn(name = "user_id", nullable = false, foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT))  
    private User user;  
  
    private Long amount;  
  
    @Version  
    private Long version;
}

// infras BalanceJpaRepository
public interface BalanceJpaRepository extends JpaRepository<Balance, Long> { 
    @Lock(LockModeType.OPTIMISTIC)  
    @Query("SELECT b FROM Balance b WHERE b.user.id= :userId")  
    Optional<Balance> findByUserIdWithLock(@Param("userId") Long userId);  
}
// infras BalanceRepositoryImpl
public class BalanceRepositoryImpl implements BalanceRepository {  
  
    private final BalanceJpaRepository balanceJpaRepository;  
    
    @Override  
    public Optional<Balance> findByUserId(Long userId) {  
       return balanceJpaRepository.findByUserIdWithLock(userId);  
    }  
}
```

Balance ì—”í‹°í‹°ì— @Versionì„ ì¶”ê°€í•˜ê³ , BalanceJpaRepositoryì˜ ì¿¼ë¦¬ì— @Lock(LockModeType.OPTIMISTIC)ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì´í›„ BalanceRepositoryImplì—ì„œ findByUserIdWithLock() ë©”ì„œë“œë¥¼ í†µí•´ ì”ì•¡ì„ ì¡°íšŒí•˜ë„ë¡ ë³€ê²½í•˜ì—¬, ì¡°íšŒ ì‹œ ë‚™ê´€ì  ë½ì´ ì ìš©ë˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

í¬ì¸íŠ¸ ì¶©ì „ì— ì‚¬ìš©í•œ ë‚™ê´€ì  ë½ì„ ê·¸ëŒ€ë¡œ ì ìš©í–ˆìŠµë‹ˆë‹¤.
### 3.4 í…ŒìŠ¤íŠ¸ ë° ì‹¤í—˜

``` java
@Test  
@DisplayName("í•œëª…ì˜ ìœ ì €ê°€ ë™ì‹œì— 2ë²ˆ ê²°ì œì‹œ í•˜ë‚˜ì˜ ê²°ì œë§Œ ì„±ê³µí•œë‹¤.")  
void payment_concurrent_success() throws InterruptedException {  
    // arrange  
    String uuid = "uuid_1";  
  
    User user = new User("kimbro", "1234");  
    userJpaRepository.save(user);  
  
    Concert concert = new Concert("ì•„ì´ìœ  10ì£¼ë…„ ì½˜ì„œíŠ¸");  
    concertJpaRepository.save(concert);  
  
    Schedule schedule = new Schedule(concert, LocalDate.now());  
    scheduleJpaRepository.save(schedule);  
  
    Seat seat = new Seat(schedule, "A1", 900L, true);  
    seatJpaRepository.save(seat);  
  
    Balance balance = new Balance(user, 1000L);  
    balanceJpaRepository.save(balance);  
  
    Token token = Token.create(user, schedule, uuid, TokenStatus.ACTIVE);  
    tokenJpaRepository.save(token);  
  
    Reservation reservation = Reservation.create(user, schedule, seat);  
    reservation.reserve(LocalDateTime.of(2025, 4, 17, 16, 35));  
    reservationJpaRepository.save(reservation);  
  
    PaymentCommand command = new PaymentCommand(user.getId(), reservation.getId(), uuid, LocalDateTime.of(2025, 4, 17, 16, 30));  
  
    int threadCount = 2;  
    ExecutorService executorService = Executors.newFixedThreadPool(threadCount);  
    CountDownLatch latch = new CountDownLatch(threadCount);  
  
    AtomicInteger successCount = new AtomicInteger(0);  
    AtomicInteger failCount = new AtomicInteger(0);  
  
    // act  
    for (int i = 0; i < threadCount; i++) {  
       executorService.submit(() -> {  
          try {  
             paymentService.pay(command);  
             successCount.incrementAndGet();  
          } catch (Exception e) {  
             failCount.incrementAndGet();  
          } finally {  
             latch.countDown();  
          }  
       });  
    }  
  
    latch.await();  
  
    // assert  
    List<Payment> payments = paymentJpaRepository.findAll();  
    Balance balance1 = balanceJpaRepository.findByUserId(user.getId()).orElseThrow();  
    assertThat(payments).hasSize(1);  
    assertThat(successCount.get()).isEqualTo(1);  
    assertThat(failCount.get()).isEqualTo(1);  
    assertThat(balance1.getAmount()).isEqualTo(100L);
}
```

ê²°ì œ ìš”ì²­ì´ ë™ì‹œì— 2ë²ˆ ë°œìƒí•˜ë©´ í•˜ë‚˜ì˜ ê²°ì œ ìš”ì²­ë§Œ ì„±ê³µí•˜ë„ë¡ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ë¥¼ êµ¬ì„±í–ˆìœ¼ë©°, ê¸°ëŒ€í•œ ëŒ€ë¡œ 1ê±´ì€ ì„±ê³µí•˜ê³  1ê±´ì€ ì‹¤íŒ¨í•˜ëŠ” ê²°ê³¼ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
